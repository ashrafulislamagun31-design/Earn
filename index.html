<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Earn Now - Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Added Adexora script -->
  <script src="https://adexora.com/cdn/ads.js?id=141"></script>
  
  <!-- Firebase App (core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      --secondary-gradient: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
      --card-bg: rgba(255, 255, 255, 0.9);
      --glass-bg: rgba(255, 255, 255, 0.15);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-dark: #2d3436;
      --text-light: #ffffff;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: var(--primary-gradient);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-dark);
    }
    
    .app-container {
      max-width: 500px;
      margin: 0 auto;
      backdrop-filter: blur(10px);
      background: var(--glass-bg);
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    header {
      background: var(--secondary-gradient);
      color: var(--text-light);
      padding: 25px 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      transform: rotate(30deg);
    }
    
    h1 {
      font-size: 28px;
      margin-bottom: 15px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .balance-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin: 20px auto;
      width: 90%;
      box-shadow: var(--shadow);
      text-align: center;
    }
    
    .balance-label {
      font-size: 16px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .balance-amount {
      font-size: 36px;
      font-weight: 800;
      color: #6a11cb;
      margin-bottom: 5px;
    }
    
    .current-date {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 10px;
    }
    
    .content-section {
      padding: 25px 20px;
      background: var(--card-bg);
      margin: 15px;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    
    h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #6a11cb;
      display: flex;
      align-items: center;
    }
    
    h2::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 24px;
      background: var(--primary-gradient);
      border-radius: 10px;
      margin-right: 12px;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: var(--text-light);
      box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4);
    }
    
    .btn-secondary {
      background: #f8f9fa;
      color: #495057;
      border: 1px solid #dee2e6;
    }
    
    .btn-secondary:hover {
      background: #e9ecef;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    input, select {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 16px;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #6a11cb;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
    }
    
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-paid {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: #4caf50;
      color: #fff;
      border-radius: 12px;
      display: none;
      z-index: 2000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    #adModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1500;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }
    
    .ad-box {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 350px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    .loading {
      width: 40px;
      height: 40px;
      border: 4px solid #eee;
      border-top: 4px solid #6a11cb;
      border-radius: 50%;
      margin: 20px auto;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
     0% { transform: rotate(0deg); }
     100% { transform: rotate(360deg); }
    }
    
    .ad-timer {
      font-size: 20px;
      font-weight: bold;
      color: #6a11cb;
      margin: 15px 0;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    th, td {
      padding: 12px 8px;
      border: 1px solid #e9ecef;
      text-align: center;
      font-size: 14px;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    
    .action-btn {
      cursor: pointer;
      padding: 6px 10px;
      margin: 0 2px;
      border-radius: 6px;
      font-size: 12px;
      border: none;
      transition: all 0.2s ease;
    }
    
    .approve {
      background: #4caf50;
      color: white;
    }
    
    .reject {
      background: #f44336;
      color: white;
    }
    
    .delete {
      background: #6c757d;
      color: white;
    }
    
    .section-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .section-toggle h2 {
      margin-bottom: 0;
    }
    
    .toggle-icon {
      font-size: 20px;
      transition: transform 0.3s ease;
    }
    
    .collapsed .toggle-icon {
      transform: rotate(180deg);
    }
    
    .hidden-section {
      display: none;
    }
    
    /* Admin Panel Styling */
    .admin-login-form {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .admin-controls-panel {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    /* Withdrawal Form Styling */
    .withdrawal-form {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      padding: 20px;
      border-radius: 16px;
      margin-top: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .form-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #6a11cb;
      text-align: center;
    }
    
    .method-cards {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .method-card {
      flex: 1;
      padding: 12px;
      border: 2px solid #e4e8f0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .method-card:hover {
      border-color: #6a11cb;
      background: rgba(106, 17, 203, 0.05);
    }
    
    .method-card.selected {
      border-color: #6a11cb;
      background: rgba(106, 17, 203, 0.1);
    }
    
    .method-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .method-name {
      font-size: 14px;
      font-weight: 600;
    }
    
    .amount-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .amount-btn {
      padding: 12px;
      border: 2px solid #e4e8f0;
      border-radius: 12px;
      background: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .amount-btn:hover {
      border-color: #6a11cb;
      background: rgba(106, 17, 203, 0.05);
    }
    
    .amount-btn.selected {
      border-color: #6a11cb;
      background: rgba(106, 17, 203, 0.1);
    }
    
    /* Country Restriction Styling */
    .country-restrictions {
      background: white;
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .country-search {
      position: relative;
      margin-bottom: 15px;
    }
    
    .country-search input {
      padding-left: 40px;
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }
    
    .country-tiers {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .tier-btn {
      padding: 10px;
      border: 2px solid #e4e8f0;
      border-radius: 8px;
      background: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .tier-btn:hover {
      border-color: #6a11cb;
      background: rgba(106, 17, 203, 0.05);
    }
    
    .tier-btn.selected {
      border-color: #6a11cb;
      background: rgba(106, 17, 203, 0.1);
    }
    
    .tier-high {
      color: #e74c3c;
    }
    
    .tier-medium {
      color: #f39c12;
    }
    
    .tier-low {
      color: #27ae60;
    }
    
    .countries-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e4e8f0;
      border-radius: 8px;
      padding: 10px;
    }
    
    .country-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .country-item:hover {
      background: #f8f9fa;
    }
    
    .country-item.selected {
      background: rgba(106, 17, 203, 0.1);
    }
    
    .country-checkbox {
      margin-right: 10px;
    }
    
    /* User Management Styling */
    .user-management {
      background: white;
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .user-search {
      position: relative;
      margin-bottom: 15px;
    }
    
    .user-search input {
      padding-left: 40px;
    }
    
    .users-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e4e8f0;
      border-radius: 8px;
      padding: 10px;
    }
    
    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f8f9fa;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
    }
    
    .user-id {
      font-size: 12px;
      color: #666;
    }
    
    .user-balance {
      font-weight: 700;
      color: #6a11cb;
      margin-right: 10px;
    }
    
    .user-actions {
      display: flex;
      gap: 5px;
    }
    
    .edit-balance-form {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .edit-balance-form input {
      flex: 1;
    }
    
    /* Firebase loading indicator */
    .firebase-loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
    }
    
    /* New styles for enhanced user management */
    .user-details-panel {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    
    .user-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .user-activity-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .user-activity-table th,
    .user-activity-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 12px;
    }
    
    .user-activity-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    .flag-icon {
      width: 20px;
      height: 15px;
      margin-right: 5px;
      vertical-align: middle;
      border: 1px solid #ddd;
    }
    
    .blocked-user {
      background-color: #fff5f5;
      border: 1px solid #ffcccc;
    }
    
    .block-btn {
      background: #f44336;
      color: white;
    }
    
    .unblock-btn {
      background: #4caf50;
      color: white;
    }
    
    .activity-badge {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .activity-ad {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .activity-withdrawal {
      background: #e8f5e9;
      color: #388e3c;
    }
    
    .activity-login {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .user-status {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .status-active {
      background: #e8f5e9;
      color: #388e3c;
    }
    
    .status-blocked {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .user-ip {
      font-family: monospace;
      font-size: 11px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="firebase-loading" id="firebaseLoading">
    <div style="text-align: center;">
      <div class="loading"></div>
      <p>Connecting to server...</p>
    </div>
  </div>

  <div class="app-container">
    <header>
      <h1>Earn Now</h1>
      <div class="balance-card">
        <div class="balance-label">Your Balance</div>
        <div class="balance-amount">‡ß≥ <span id="balance">0.00</span></div>
      </div>
      <div id="current-date" class="current-date"></div>
    </header>

    <main>
      <div class="content-section">
        <div class="section-toggle" id="earn-section-toggle">
          <h2>Watch Ads & Earn</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div id="earn-section">
          <button class="btn btn-primary" id="watch-ad-btn">
            <span>üëÅÔ∏è</span> Watch Ad & Earn ‡ß≥<span id="per-ad-amount">0.06</span>
          </button>
        </div>
      </div>

      <div class="content-section">
        <div class="section-toggle" id="withdraw-section-toggle">
          <h2>Withdraw Money</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div id="withdraw-section">
          <button class="btn btn-secondary" id="withdraw-btn">
            <span>üí∏</span> Request Withdrawal
          </button>
          
          <div id="withdraw-form" class="withdrawal-form hidden-section">
            <div class="form-title">Withdrawal Request</div>
            
            <div class="input-group">
              <div class="input-label">Select Method</div>
              <div class="method-cards">
                <div class="method-card" data-method="bkash">
                  <div class="method-icon">üì±</div>
                  <div class="method-name">bKash</div>
                </div>
                <div class="method-card" data-method="nagad">
                  <div class="method-icon">üí≥</div>
                  <div class="method-name">Nagad</div>
                </div>
                <div class="method-card" data-method="recharge">
                  <div class="method-icon">üìû</div>
                  <div class="method-name">Recharge</div>
                </div>
              </div>
              <select id="withdraw-method" class="hidden-section">
                <option value="">Select withdrawal method</option>
                <option value="bkash">bKash</option>
                <option value="nagad">Nagad</option>
                <option value="recharge">Mobile Recharge</option>
              </select>
            </div>
            
            <div class="input-group">
              <div class="input-label">Account/Mobile Number</div>
              <input type="text" id="account-number" placeholder="Enter your number">
            </div>
            
            <div class="input-group">
              <div class="input-label">Select Amount (‡ß≥)</div>
              <div class="amount-buttons">
                <button class="amount-btn" data-amount="20">‡ß≥20</button>
                <button class="amount-btn" data-amount="50">‡ß≥50</button>
                <button class="amount-btn" data-amount="100">‡ß≥100</button>
                <button class="amount-btn" data-amount="200">‡ß≥200</button>
                <button class="amount-btn" data-amount="300">‡ß≥300</button>
                <button class="amount-btn" data-amount="500">‡ß≥500</button>
              </div>
              <input type="number" id="withdraw-amount" placeholder="Enter amount (20 - 500)" min="20" max="500">
            </div>
            
            <button class="btn btn-primary" id="submit-withdraw">
              <span>‚úÖ</span> Submit Request
            </button>
          </div>

          <h3 style="margin-top: 20px;">Withdrawal History</h3>
          <div id="history-items"></div>
        </div>
      </div>

      <div class="content-section">
        <div class="section-toggle" id="admin-section-toggle">
          <h2>Admin Panel</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div id="admin-section" class="hidden-section">
          <div class="admin-login-form">
            <div class="input-group">
              <div class="input-label">Admin Password</div>
              <input type="password" id="admin-password" placeholder="Enter admin password">
            </div>
            <button class="btn btn-primary" id="admin-login">
              <span>üîë</span> Login
            </button>
          </div>
          
          <div id="admin-controls" class="admin-controls-panel hidden-section">
            <div class="form-title">Admin Settings</div>
            
            <div class="input-group">
              <div class="input-label">Per Ad Rate (‡ß≥)</div>
              <input type="number" id="per-ad-rate" step="0.06" value="0.06" min="0.06" placeholder="Enter amount per ad">
            </div>
            
            <div class="country-restrictions">
              <h3>Country Restrictions by eCPM Tier</h3>
              
              <div class="country-search">
                <span class="search-icon">üîç</span>
                <input type="text" id="country-search" placeholder="Search for countries...">
              </div>
              
              <div class="country-tiers">
                <div class="tier-btn tier-high" data-tier="high">High eCPM</div>
                <div class="tier-btn tier-medium" data-tier="medium">Medium eCPM</div>
                <div class="tier-btn tier-low" data-tier="low">Low eCPM</div>
              </div>
              
              <div class="countries-list" id="countries-list"></div>
              
              <div class="input-group">
                <div class="input-label">Selected Countries</div>
                <div id="selected-countries"></div>
              </div>
            </div>
            
            <div class="user-management">
              <h3>User Management</h3>
              
              <div class="user-search">
                <span class="search-icon">üîç</span>
                <input type="text" id="user-search" placeholder="Search users...">
              </div>
              
              <div class="users-list" id="users-list"></div>
            </div>
            
            <button class="btn btn-primary" id="save-settings">
              <span>üíæ</span> Save Settings
            </button>
            
            <h3 style="margin-top: 20px;">Withdrawal Requests</h3>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>User</th><th>Method</th><th>Number</th><th>Amount</th><th>Date</th><th>Status</th><th>Action</th>
                  </tr>
                </thead>
                <tbody id="withdraw-requests"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Ad Modal -->
  <div id="adModal">
    <div class="ad-box">
      <h3>Advertisement</h3>
      <div class="loading"></div>
      <div class="ad-timer" id="adTimer">Ad loading...</div>
      <!-- Removed the close button -->
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDp49URVg2ipSBuoEBGZyqWWyc29cxAleE",
      authDomain: "easy-earn-af82c.firebaseapp.com",
      projectId: "easy-earn-af82c",
      storageBucket: "easy-earn-af82c.firebasestorage.app",
      messagingSenderId: "572340074151",
      appId: "1:572340074151:web:778d58946c1163427acd82",
      measurementId: "G-3RFZSPZD9W"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener("DOMContentLoaded", async () => {
      const tg = window.Telegram.WebApp;
      tg.expand();
      
      // Show loading indicator immediately
      document.getElementById("firebaseLoading").style.display = "flex";

      // Country data with eCPM tiers
      const countryData = [
        {code: "US", name: "United States", tier: "high"},
        {code: "CA", name: "Canada", tier: "high"},
        {code: "GB", name: "United Kingdom", tier: "high"},
        {code: "AU", name: "Australia", tier: "high"},
        {code: "DE", name: "Germany", tier: "high"},
        {code: "FR", name: "France", tier: "high"},
        {code: "JP", name: "Japan", tier: "high"},
        {code: "KR", name: "South Korea", tier: "high"},
        {code: "SG", name: "Singapore", tier: "high"},
        {code: "NL", name: "Netherlands", tier: "high"},
        {code: "SE", name: "Sweden", tier: "high"},
        {code: "NO", name: "Norway", tier: "high"},
        {code: "CH", name: "Switzerland", tier: "high"},
        {code: "DK", name: "Denmark", tier: "high"},
        {code: "FI", name: "Finland", tier: "high"},
        {code: "IE", name: "Ireland", tier: "high"},
        {code: "AT", name: "Austria", tier: "high"},
        {code: "BE", name: "Belgium", tier: "high"},
        {code: "NZ", name: "New Zealand", tier: "high"},
        {code: "IT", name: "Italy", tier: "medium"},
        {code: "ES", name: "Spain", tier: "medium"},
        {code: "BR", name: "Brazil", tier: "medium"},
        {code: "MX", name: "Mexico", tier: "medium"},
        {code: "PL", name: "Poland", tier: "medium"},
        {code: "RU", name: "Russia", tier: "medium"},
        {code: "TR", name: "Turkey", tier: "medium"},
        {code: "SA", name: "Saudi Arabia", tier: "medium"},
        {code: "ZA", name: "South Africa", tier: "medium"},
        {code: "AR", name: "Argentina", tier: "medium"},
        {code: "CL", name: "Chile", tier: "medium"},
        {code: "CO", name: "Colombia", tier: "medium"},
        {code: "MY", name: "Malaysia", tier: "medium"},
        {code: "TH", name: "Thailand", tier: "medium"},
        {code: "ID", name: "Indonesia", tier: "medium"},
        {code: "PH", name: "Philippines", tier: "medium"},
        {code: "VN", name: "Vietnam", tier: "medium"},
        {code: "IN", name: "India", tier: "low"},
        {code: "PK", name: "Pakistan", tier: "low"},
        {code: "BD", name: "Bangladesh", tier: "low"},
        {code: "NG", name: "Nigeria", tier: "low"},
        {code: "EG", name: "Egypt", tier: "low"},
        {code: "ET", name: "Ethiopia", tier: "low"},
        {code: "KE", name: "Kenya", tier: "low"},
        {code: "GH", name: "Ghana", tier: "low"},
        {code: "TZ", name: "Tanzania", tier: "low"},
        {code: "UG", name: "Uganda", tier: "low"},
        {code: "MM", name: "Myanmar", tier: "low"},
        {code: "KH", name: "Cambodia", tier: "low"},
        {code: "LA", name: "Laos", tier: "low"},
        {code: "NP", name: "Nepal", tier: "low"},
        {code: "LK", name: "Sri Lanka", tier: "low"}
      ];

      // Check country restrictions before allowing access
      try {
        const settingsDoc = await db.collection("settings").doc("countryRestrictions").get();
        const countrySettings = settingsDoc.exists ? settingsDoc.data() : {allowedCountries: [], restrictionEnabled: false};
        
        // If country restriction is enabled, check user's access
        if (countrySettings.restrictionEnabled && countrySettings.allowedCountries.length > 0) {
          try {
            // Get user's actual IP and country
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipResponse.json();
            const userIP = ipData.ip;
            
            const locationResponse = await fetch(`https://ipapi.co/${userIP}/country/`);
            const userCountry = await locationResponse.text();
            
            // Check if user's country is allowed
            if (!countrySettings.allowedCountries.includes(userCountry.toUpperCase())) {
              document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--primary-gradient); color: white; text-align: center; padding: 20px;">
                  <div>
                    <h2>Access Restricted</h2>
                    <p>This application is not available in your country (${userCountry}).</p>
                    <p>Please contact support if you believe this is an error.</p>
                  </div>
                </div>
              `;
              return;
            }
          } catch (error) {
            console.error("Error checking country restrictions:", error);
            // If there's an error, allow access but show a warning
            showNotification("‚ö†Ô∏è Could not verify location. Some features may be restricted.", false);
          }
        }
      } catch (error) {
        console.error("Error loading country restrictions:", error);
      }

      let userId = "guest_" + Math.floor(Math.random()*99999);
      let userName = "Guest User";
      let userUsername = "guest";
      
      if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        userId = "user_" + tg.initDataUnsafe.user.id;
        userName = tg.initDataUnsafe.user.first_name + (tg.initDataUnsafe.user.last_name ? " " + tg.initDataUnsafe.user.last_name : "");
        userUsername = tg.initDataUnsafe.user.username || "no_username";
      }

      const balanceEl = document.getElementById("balance");
      const perAdAmountEl = document.getElementById("per-ad-amount");
      const watchAdBtn = document.getElementById("watch-ad-btn");
      const withdrawBtn = document.getElementById("withdraw-btn");
      const withdrawForm = document.getElementById("withdraw-form");
      const submitWithdrawBtn = document.getElementById("submit-withdraw");
      const historyItems = document.getElementById("history-items");
      const adminLoginBtn = document.getElementById("admin-login");
      const adminControls = document.getElementById("admin-controls");
      const perAdRateInput = document.getElementById("per-ad-rate");
      const saveSettingsBtn = document.getElementById("save-settings");
      const withdrawRequestsTable = document.getElementById("withdraw-requests");
      const notification = document.getElementById("notification");
      const countriesList = document.getElementById("countries-list");
      const selectedCountries = document.getElementById("selected-countries");
      const countrySearch = document.getElementById("country-search");
      const tierButtons = document.querySelectorAll('.tier-btn');
      const usersList = document.getElementById("users-list");
      const userSearch = document.getElementById("user-search");

      const adModal = document.getElementById("adModal");
      const adTimer = document.getElementById("adTimer");

      // Section toggles
      const earnSectionToggle = document.getElementById("earn-section-toggle");
      const withdrawSectionToggle = document.getElementById("withdraw-section-toggle");
      const adminSectionToggle = document.getElementById("admin-section-toggle");
      
      const earnSection = document.getElementById("earn-section");
      const withdrawSection = document.getElementById("withdraw-section");
      const adminSection = document.getElementById("admin-section");

      // Withdrawal form elements
      const methodCards = document.querySelectorAll('.method-card');
      const amountButtons = document.querySelectorAll('.amount-btn');
      const withdrawMethodSelect = document.getElementById('withdraw-method');
      const accountNumberInput = document.getElementById('account-number');
      const withdrawAmountInput = document.getElementById('withdraw-amount');

      let userData = { balance: 0, userId: userId, name: userName, username: userUsername };
      let allRequests = [];
      let allUsers = [];
      let perAdRate = 0.06;
      let isAdminLoggedIn = false;
      let currentTierFilter = "all";
      let selectedCountryCodes = [];
      let userIP = "";
      let userCountry = "";

      // Get user IP and country
      async function getUserLocation() {
        try {
          const ipResponse = await fetch('https://api.ipify.org?format=json');
          const ipData = await ipResponse.json();
          userIP = ipData.ip;
          
          const locationResponse = await fetch(`https://ipapi.co/${userIP}/json/`);
          const locationData = await locationResponse.json();
          userCountry = locationData.country_code;
          
          // Update user data with location information
          userData.ip = userIP;
          userData.country = userCountry;
          userData.lastLogin = new Date().toISOString();
          
          // Save to Firebase
          await db.collection("users").doc(userId).update({
            ip: userIP,
            country: userCountry,
            lastLogin: new Date().toISOString()
          });
        } catch (error) {
          console.error("Error getting user location:", error);
        }
      }

      // Firebase data loading functions
      async function loadUserData() {
        try {
          const userDoc = await db.collection("users").doc(userId).get();
          if (userDoc.exists) {
            userData = userDoc.data();
            
            // Check if user is blocked
            if (userData.isBlocked) {
              document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--primary-gradient); color: white; text-align: center; padding: 20px;">
                  <div>
                    <h2>Account Blocked</h2>
                    <p>Your account has been blocked by the administrator.</p>
                    <p>Please contact support if you believe this is an error.</p>
                  </div>
                </div>
              `;
              return;
            }
          } else {
            // Create new user document
            userData = { 
              balance: 0, 
              userId: userId, 
              name: userName, 
              username: userUsername,
              registrationDate: new Date().toISOString(),
              adHistory: [],
              activityLog: [],
              isBlocked: false
            };
            await db.collection("users").doc(userId).set(userData);
            
            // Get user location
            await getUserLocation();
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          showNotification("Error loading user data", false);
        }
      }

      async function loadAllRequests() {
        try {
          const requestsSnapshot = await db.collection("withdrawalRequests")
            .orderBy("date", "desc")
            .get();
          
          allRequests = [];
          requestsSnapshot.forEach(doc => {
            allRequests.push(doc.data());
          });
        } catch (error) {
          console.error("Error loading withdrawal requests:", error);
        }
      }

      async function loadAllUsers() {
        try {
          const usersSnapshot = await db.collection("users").get();
          
          allUsers = [];
          usersSnapshot.forEach(doc => {
            allUsers.push(doc.data());
          });
        } catch (error) {
          console.error("Error loading users:", error);
        }
      }

      async function loadSettings() {
        try {
          const settingsDoc = await db.collection("settings").doc("appSettings").get();
          if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            perAdRate = settings.perAdRate || 0.06;
          }
          
          const countrySettingsDoc = await db.collection("settings").doc("countryRestrictions").get();
          if (countrySettingsDoc.exists) {
            const countrySettings = countrySettingsDoc.data();
            selectedCountryCodes = countrySettings.allowedCountries || [];
          }
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      // Firebase data saving functions
      async function saveUserData() {
        try {
          await db.collection("users").doc(userId).set(userData);
        } catch (error) {
          console.error("Error saving user data:", error);
          showNotification("Error saving data", false);
        }
      }

      async function saveWithdrawalRequest(request) {
        try {
          await db.collection("withdrawalRequests").add(request);
        } catch (error) {
          console.error("Error saving withdrawal request:", error);
          showNotification("Error submitting request", false);
        }
      }

      async function updateWithdrawalRequest(index, updates) {
        try {
          const request = allRequests[index];
          // Since we don't have document IDs stored, we need to query by unique fields
          const querySnapshot = await db.collection("withdrawalRequests")
            .where("userId", "==", request.userId)
            .where("date", "==", request.date)
            .get();
          
          if (!querySnapshot.empty) {
            const docId = querySnapshot.docs[0].id;
            await db.collection("withdrawalRequests").doc(docId).update(updates);
          }
        } catch (error) {
          console.error("Error updating withdrawal request:", error);
        }
      }

      async function deleteWithdrawalRequest(index) {
        try {
          const request = allRequests[index];
          // Since we don't have document IDs stored, we need to query by unique fields
          const querySnapshot = await db.collection("withdrawalRequests")
            .where("userId", "==", request.userId)
            .where("date", "==", request.date)
            .get();
          
          if (!querySnapshot.empty) {
            const docId = querySnapshot.docs[0].id;
            await db.collection("withdrawalRequests").doc(docId).delete();
          }
        } catch (error) {
          console.error("Error deleting withdrawal request:", error);
        }
      }

      async function saveSettings() {
        try {
          await db.collection("settings").doc("appSettings").set({
            perAdRate: perAdRate
          });
          
          await db.collection("settings").doc("countryRestrictions").set({
            allowedCountries: selectedCountryCodes,
            restrictionEnabled: selectedCountryCodes.length > 0
          });
        } catch (error) {
          console.error("Error saving settings:", error);
          showNotification("Error saving settings", false);
        }
      }

      async function updateUserInAllUsers(userId, updates) {
        try {
          await db.collection("users").doc(userId).update(updates);
        } catch (error) {
          console.error("Error updating user:", error);
        }
      }

      async function loadData() {
        // Show loading indicator
        document.getElementById("firebaseLoading").style.display = "flex";
        
        try {
          await Promise.all([
            loadUserData(),
            loadAllRequests(),
            loadAllUsers(),
            loadSettings()
          ]);
          
          updateUI();
          renderCountryList();
          renderSelectedCountries();
          renderUsersList();
        } catch (error) {
          console.error("Error loading data:", error);
          showNotification("Error loading data", false);
        } finally {
          // Hide loading indicator
          document.getElementById("firebaseLoading").style.display = "none";
        }
      }
      
      function updateUI() {
        balanceEl.textContent = userData.balance.toFixed(2);
        perAdAmountEl.textContent = perAdRate.toFixed(2);
        updateHistory();
        updateRequestsTable();
      }

      function showNotification(msg, success=true) {
        notification.textContent = msg;
        notification.style.background = success ? "#4caf50" : "#f44336";
        notification.style.display = "block";
        setTimeout(()=>notification.style.display="none",2000);
      }

      function updateHistory() {
        historyItems.innerHTML = "";
        const userRequests = allRequests.filter(r=>r.userId===userId);
        
        if (userRequests.length === 0) {
          historyItems.innerHTML = '<div style="text-align: center; padding: 15px; color: #666;">No withdrawal history yet</div>';
          return;
        }
        
        userRequests.forEach(r=>{
          let div = document.createElement("div");
          div.className = "history-item";
          div.innerHTML = `
            <div>
              <strong>${r.method}</strong> - ‡ß≥${r.amount}
              <div style="font-size: 12px; color: #666;">${r.date}</div>
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          `;
          historyItems.appendChild(div);
        });
      }

      function updateRequestsTable() {
        withdrawRequestsTable.innerHTML = "";
        
        if (allRequests.length === 0) {
          withdrawRequestsTable.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                No withdrawal requests yet
              </td>
            </tr>
          `;
          return;
        }
        
        allRequests.forEach((r,i)=>{
          let row = document.createElement("tr");
          row.innerHTML = `
            <td>${r.userId}</td>
            <td>${r.method}</td>
            <td>${r.number}</td>
            <td>‡ß≥${r.amount}</td>
            <td>${r.date}</td>
            <td><span class="status-badge status-${r.status}">${r.status}</span></td>
            <td>
              <button class="action-btn approve" data-index="${i}">‚úî</button>
              <button class="action-btn reject" data-index="${i}">‚úñ</button>
              <button class="action-btn delete" data-index="${i}">‚ùå</button>
            </td>`;
          withdrawRequestsTable.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.approve').forEach(btn => {
          btn.addEventListener('click', async () => {
            const index = btn.getAttribute('data-index');
            allRequests[index].status = "paid";
            
            // Update in Firebase
            await updateWithdrawalRequest(index, { status: "paid" });
            
            updateUI();
            showNotification("Request approved");
          });
        });
        
        document.querySelectorAll('.reject').forEach(btn => {
          btn.addEventListener('click', async () => {
            const index = btn.getAttribute('data-index');
            allRequests[index].status = "rejected";
            
            // Update in Firebase
            await updateWithdrawalRequest(index, { status: "rejected" });
            
            updateUI();
            showNotification("Request rejected");
          });
        });
        
        document.querySelectorAll('.delete').forEach(btn => {
          btn.addEventListener('click', async () => {
            const index = btn.getAttribute('data-index');
            
            // Delete from Firebase
            await deleteWithdrawalRequest(index);
            
            // Remove from local array
            allRequests.splice(index, 1);
            
            updateUI();
            showNotification("Request deleted");
          });
        });
      }

      function renderCountryList() {
        countriesList.innerHTML = "";
        
        const searchTerm = countrySearch.value.toLowerCase();
        let filteredCountries = countryData;
        
        // Filter by search term
        if (searchTerm) {
          filteredCountries = filteredCountries.filter(country => 
            country.name.toLowerCase().includes(searchTerm) || 
            country.code.toLowerCase().includes(searchTerm)
          );
        }
        
        // Filter by tier
        if (currentTierFilter !== "all") {
          filteredCountries = filteredCountries.filter(country => country.tier === currentTierFilter);
        }
        
        // Render countries
        filteredCountries.forEach(country => {
          const isSelected = selectedCountryCodes.includes(country.code);
          
          const countryItem = document.createElement("div");
          countryItem.className = `country-item ${isSelected ? "selected" : ""}`;
          countryItem.innerHTML = `
            <input type="checkbox" class="country-checkbox" data-code="${country.code}" ${isSelected ? "checked" : ""}>
            ${country.name} (${country.code}) - <span class="tier-${country.tier}">${country.tier}</span>
          `;
          
          countryItem.addEventListener("click", (e) => {
            if (e.target.type !== "checkbox") {
              const checkbox = countryItem.querySelector(".country-checkbox");
              checkbox.checked = !checkbox.checked;
              handleCountrySelection(country.code, checkbox.checked);
            }
          });
          
          const checkbox = countryItem.querySelector(".country-checkbox");
          checkbox.addEventListener("change", () => {
            handleCountrySelection(country.code, checkbox.checked);
          });
          
          countriesList.appendChild(countryItem);
        });
      }
      
      function handleCountrySelection(countryCode, isSelected) {
        if (isSelected) {
          if (!selectedCountryCodes.includes(countryCode)) {
            selectedCountryCodes.push(countryCode);
          }
        } else {
          selectedCountryCodes = selectedCountryCodes.filter(code => code !== countryCode);
        }
        
        renderSelectedCountries();
      }
      
      function renderSelectedCountries() {
        if (selectedCountryCodes.length === 0) {
          selectedCountries.innerHTML = "<div style='color: #666; padding: 10px; text-align: center;'>No countries selected</div>";
          return;
        }
        
        selectedCountries.innerHTML = "";
        selectedCountryCodes.forEach(code => {
          const country = countryData.find(c => c.code === code);
          if (country) {
            const badge = document.createElement("span");
            badge.className = "status-badge";
            badge.textContent = `${country.name} (${code})`;
            badge.style.margin = "0 5px 5px 0";
            badge.style.cursor = "pointer";
            
            badge.addEventListener("click", () => {
              selectedCountryCodes = selectedCountryCodes.filter(c => c !== code);
              renderSelectedCountries();
              renderCountryList();
            });
            
            selectedCountries.appendChild(badge);
          }
        });
      }
      
      function renderUsersList() {
        usersList.innerHTML = "";
        
        const searchTerm = userSearch.value.toLowerCase();
        let filteredUsers = allUsers;
        
        // Filter by search term
        if (searchTerm) {
          filteredUsers = filteredUsers.filter(user => 
            user.name.toLowerCase().includes(searchTerm) || 
            user.username.toLowerCase().includes(searchTerm) ||
            user.userId.toLowerCase().includes(searchTerm)
          );
        }
        
        if (filteredUsers.length === 0) {
          usersList.innerHTML = "<div style='color: #666; padding: 10px; text-align: center;'>No users found</div>";
          return;
        }
        
        // Render users
        filteredUsers.forEach(user => {
          const userItem = document.createElement("div");
          userItem.className = `user-item ${user.isBlocked ? "blocked-user" : ""}`;
          
          // Get country flag URL if available
          const flagUrl = user.country ? `https://flagcdn.com/w20/${user.country.toLowerCase()}.png` : '';
          
          userItem.innerHTML = `
            <div class="user-info">
              <div class="user-name">${user.name} ${user.isBlocked ? 'üî¥' : 'üü¢'}</div>
              <div class="user-id">@${user.username} | ${user.userId}</div>
              ${user.country ? `<div><img src="${flagUrl}" class="flag-icon" alt="${user.country}"> ${user.country}</div>` : ''}
            </div>
            <div class="user-balance">‡ß≥${user.balance.toFixed(2)}</div>
            <div class="user-actions">
              <button class="action-btn approve edit-user" data-user="${user.userId}">‚úèÔ∏è</button>
              ${user.isBlocked ? 
                `<button class="action-btn unblock-btn unblock-user" data-user="${user.userId}">Unblock</button>` : 
                `<button class="action-btn block-btn block-user" data-user="${user.userId}">Block</button>`
              }
              <button class="action-btn view-details" data-user="${user.userId}">üëÅÔ∏è</button>
            </div>
          `;
          
          usersList.appendChild(userItem);
        });
        
        // Add event listeners to edit buttons
        document.querySelectorAll('.edit-user').forEach(btn => {
          btn.addEventListener('click', () => {
            const userId = btn.getAttribute('data-user');
            editUserBalance(userId);
          });
        });
        
        // Add event listeners to block buttons
        document.querySelectorAll('.block-user').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.getAttribute('data-user');
            await blockUser(userId, true);
          });
        });
        
        // Add event listeners to unblock buttons
        document.querySelectorAll('.unblock-user').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.getAttribute('data-user');
            await blockUser(userId, false);
          });
        });
        
        // Add event listeners to view details buttons
        document.querySelectorAll('.view-details').forEach(btn => {
          btn.addEventListener('click', () => {
            const userId = btn.getAttribute('data-user');
            showUserDetails(userId);
          });
        });
      }
      
      function editUserBalance(userId) {
        const user = allUsers.find(u => u.userId === userId);
        if (!user) return;
        
        const userItem = document.querySelector(`.edit-user[data-user="${userId}"]`).closest('.user-item');
        
        // Check if edit form already exists
        if (userItem.querySelector('.edit-balance-form')) {
          userItem.querySelector('.edit-balance-form').remove();
          return;
        }
        
        // Remove any other edit forms
        document.querySelectorAll('.edit-balance-form').forEach(form => form.remove());
        
        const editForm = document.createElement("div");
        editForm.className = "edit-balance-form";
        editForm.innerHTML = `
          <input type="number" step="0.01" value="${user.balance}" placeholder="New balance">
          <button class="action-btn approve save-balance">Save</button>
          <button class="action-btn delete cancel-edit">Cancel</button>
        `;
        
        userItem.appendChild(editForm);
        
        // Add event listeners
        editForm.querySelector('.save-balance').addEventListener('click', async () => {
          const newBalance = parseFloat(editForm.querySelector('input').value);
          if (!isNaN(newBalance)) {
            // Update user balance in allUsers
            const userIndex = allUsers.findIndex(u => u.userId === userId);
            allUsers[userIndex].balance = newBalance;
            
            // Update in Firebase
            await updateUserInAllUsers(userId, { balance: newBalance });
            
            // If it's the current user, update their balance too
            if (userId === userData.userId) {
              userData.balance = newBalance;
              updateUI();
            }
            
            showNotification("Balance updated successfully");
            renderUsersList();
          }
        });
        
        editForm.querySelector('.cancel-edit').addEventListener('click', () => {
          editForm.remove();
        });
      }
      
      async function blockUser(userId, block) {
        const user = allUsers.find(u => u.userId === userId);
        if (!user) return;
        
        // Update user in allUsers
        const userIndex = allUsers.findIndex(u => u.userId === userId);
        allUsers[userIndex].isBlocked = block;
        
        // Update in Firebase
        await updateUserInAllUsers(userId, { isBlocked: block });
        
        // If blocking the current user, log them out
        if (block && userId === userData.userId) {
          showNotification("You have been blocked by an administrator", false);
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
        
        showNotification(`User ${block ? "blocked" : "unblocked"} successfully`);
        renderUsersList();
      }
      
      function showUserDetails(userId) {
        const user = allUsers.find(u => u.userId === userId);
        if (!user) return;
        
        // Remove any existing details panel
        document.querySelectorAll('.user-details-panel').forEach(panel => panel.remove());
        
        // Check if details panel already exists for this user
        const existingPanel = document.querySelector(`.user-details-panel[data-user="${userId}"]`);
        if (existingPanel) {
          existingPanel.remove();
          return;
        }
        
        const userItem = document.querySelector(`.view-details[data-user="${userId}"]`).closest('.user-item');
        
        const detailsPanel = document.createElement("div");
        detailsPanel.className = "user-details-panel";
        detailsPanel.setAttribute("data-user", userId);
        
        // Get country flag URL
        const flagUrl = user.country ? `https://flagcdn.com/w40/${user.country.toLowerCase()}.png` : '';
        
        detailsPanel.innerHTML = `
          <div class="user-details-header">
            <h4>User Details</h4>
            <span class="user-status ${user.isBlocked ? 'status-blocked' : 'status-active'}">
              ${user.isBlocked ? 'Blocked' : 'Active'}
            </span>
          </div>
          <div>
            <strong>IP Address:</strong> <span class="user-ip">${user.ip || 'N/A'}</span>
          </div>
          <div>
            <strong>Country:</strong> 
            ${user.country && flagUrl ? `<img src="${flagUrl}" class="flag-icon" alt="${user.country}"> ${user.country}` : 'N/A'}
          </div>
          <div>
            <strong>Last Login:</strong> ${user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A'}
          </div>
          <div>
            <strong>Registration Date:</strong> ${user.registrationDate ? new Date(user.registrationDate).toLocaleString() : 'N/A'}
          </div>
          
          <h4 style="margin-top: 15px;">Activity History</h4>
          ${user.activityLog && user.activityLog.length > 0 ? `
            <table class="user-activity-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Activity</th>
                  <th>IP</th>
                  <th>Country</th>
                </tr>
              </thead>
              <tbody>
                ${user.activityLog.slice(-5).map(activity => `
                  <tr>
                    <td>${new Date(activity.date).toLocaleString()}</td>
                    <td><span class="activity-badge activity-${activity.type}">${activity.type}</span></td>
                    <td class="user-ip">${activity.ip || 'N/A'}</td>
                    <td>${activity.country ? `<img src="https://flagcdn.com/w20/${activity.country.toLowerCase()}.png" class="flag-icon" alt="${activity.country}"> ${activity.country}` : 'N/A'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : '<p>No activity history</p>'}
        `;
        
        userItem.appendChild(detailsPanel);
      }

      // === Ad Watch ===
      watchAdBtn.onclick = async ()=>{
        adModal.style.display="flex";
        adTimer.textContent = "Loading ad...";

        // Get the current per-ad rate to ensure it's up to date
        const currentPerAdRate = perAdRate;
        
        // Use Adexora ad
        if(typeof window.showAdexora === "function"){
          window.showAdexora()
            .then(async ()=>{
              adTimer.textContent = "‚úÖ Ad finished!";
              userData.balance += currentPerAdRate;
              
              // Add to activity log
              const activity = {
                type: "ad",
                date: new Date().toISOString(),
                amount: currentPerAdRate,
                ip: userIP,
                country: userCountry
              };
              
              if (!userData.activityLog) userData.activityLog = [];
              userData.activityLog.push(activity);
              
              // Update user in allUsers
              const userIndex = allUsers.findIndex(u => u.userId === userId);
              if (userIndex !== -1) {
                allUsers[userIndex].balance = userData.balance;
                if (!allUsers[userIndex].activityLog) allUsers[userIndex].activityLog = [];
                allUsers[userIndex].activityLog.push(activity);
              }
              
              // Save to Firebase
              await saveUserData();
              updateUI();
              showNotification("You earned ‡ß≥"+currentPerAdRate.toFixed(2));
              
              // Auto-close the ad modal after 2 seconds
              setTimeout(() => {
                adModal.style.display = "none";
              }, 2000);
            })
            .catch(e=>{
              adModal.style.display="none";
              showNotification("‚ùå Failed to load ad",false);
              console.error("Ad error:", e);
            });
        } else {
          // Fallback for testing without ad library
          adTimer.textContent = "‚úÖ Ad finished!";
          userData.balance += currentPerAdRate;
          
          // Add to activity log
          const activity = {
            type: "ad",
            date: new Date().toISOString(),
            amount: currentPerAdRate,
            ip: userIP,
            country: userCountry
          };
          
          if (!userData.activityLog) userData.activityLog = [];
          userData.activityLog.push(activity);
          
          // Update user in allUsers
          const userIndex = allUsers.findIndex(u => u.userId === userId);
          if (userIndex !== -1) {
            allUsers[userIndex].balance = userData.balance;
            if (!allUsers[userIndex].activityLog) allUsers[userIndex].activityLog = [];
            allUsers[userIndex].activityLog.push(activity);
          }
          
          // Save to Firebase
          await saveUserData();
          updateUI();
          showNotification("You earned ‡ß≥"+currentPerAdRate.toFixed(2));
          
          // Auto-close the ad modal after 2 seconds
          setTimeout(() => {
            adModal.style.display = "none";
          }, 2000);
        }
      };

      // Withdraw
      withdrawBtn.onclick = ()=> {
        withdrawForm.classList.toggle("hidden-section");
      };
      
      // Method card selection
      methodCards.forEach(card => {
        card.addEventListener('click', () => {
          methodCards.forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          withdrawMethodSelect.value = card.dataset.method;
        });
      });
      
      // Amount button selection
      amountButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          amountButtons.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          withdrawAmountInput.value = btn.dataset.amount;
        });
      });
      
      submitWithdrawBtn.onclick = async ()=>{
        let method = withdrawMethodSelect.value;
        let number = accountNumberInput.value;
        let amount = parseFloat(withdrawAmountInput.value);
        
        if(!method || !number || isNaN(amount)) return showNotification("‚ö†Ô∏è Fill all fields",false);
        if(amount<20||amount>500) return showNotification("‚ö†Ô∏è Amount must be 20-500",false);
        if(userData.balance<amount) return showNotification("‚ö†Ô∏è Insufficient balance",false);
        
        userData.balance -= amount;
        
        // Add to activity log
        const activity = {
          type: "withdrawal",
          date: new Date().toISOString(),
          amount: amount,
          method: method,
          ip: userIP,
          country: userCountry
        };
        
        if (!userData.activityLog) userData.activityLog = [];
        userData.activityLog.push(activity);
        
        // Update user in allUsers
        const userIndex = allUsers.findIndex(u => u.userId === userId);
        if (userIndex !== -1) {
          allUsers[userIndex].balance = userData.balance;
          if (!allUsers[userIndex].activityLog) allUsers[userIndex].activityLog = [];
          allUsers[userIndex].activityLog.push(activity);
        }
        
        const requestData = {
          userId:userData.userId,
          method,
          number,
          amount,
          status:"pending",
          date:new Date().toLocaleString()
        };
        
        allRequests.push(requestData);
        
        // Save to Firebase
        await Promise.all([
          saveUserData(),
          saveWithdrawalRequest(requestData)
        ]);
        
        updateUI();
        withdrawForm.classList.add("hidden-section");
        
        // Reset form
        methodCards.forEach(c => c.classList.remove('selected'));
        amountButtons.forEach(b => b.classList.remove('selected'));
        withdrawMethodSelect.value = "";
        accountNumberInput.value = "";
        withdrawAmountInput.value = "";
        
        showNotification("‚úÖ Withdraw request submitted");
      };

      // Admin
      adminLoginBtn.onclick = ()=>{
        const pass=document.getElementById("admin-password").value;
        if(pass==="eatt7242888"){
          isAdminLoggedIn = true;
          adminControls.classList.remove("hidden-section");
          // Set the current per-ad rate in the admin input
          perAdRateInput.value = perAdRate.toFixed(2);
          showNotification("‚úÖ Admin logged in");
        } else {
          showNotification("‚ùå Wrong password",false);
        }
      };
      
      saveSettingsBtn.onclick = async ()=>{
        perAdRate = parseFloat(perAdRateInput.value)||0.06;
        
        // Save to Firebase
        await saveSettings();
        
        updateUI();
        showNotification("‚úÖ Settings saved");
      };

      // Section toggle functionality
      earnSectionToggle.addEventListener("click", () => {
        earnSection.classList.toggle("hidden-section");
        earnSectionToggle.classList.toggle("collapsed");
      });
      
      withdrawSectionToggle.addEventListener("click", () => {
        withdrawSection.classList.toggle("hidden-section");
        withdrawSectionToggle.classList.toggle("collapsed");
      });
      
      adminSectionToggle.addEventListener("click", () => {
        adminSection.classList.toggle("hidden-section");
        adminSectionToggle.classList.toggle("collapsed");
        
        // If admin is logged in, show controls
        if (isAdminLoggedIn) {
          adminControls.classList.remove("hidden-section");
        }
      });

      // Country search functionality
      countrySearch.addEventListener("input", () => {
        renderCountryList();
      });
      
      // Tier filter functionality
      tierButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          tierButtons.forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          currentTierFilter = btn.dataset.tier;
          renderCountryList();
        });
      });
      
      // User search functionality
      userSearch.addEventListener("input", () => {
        renderUsersList();
      });

      // Init
      loadData();
      document.getElementById("current-date").textContent=new Date().toDateString();
    });
  </script>
</body>
  </html>
