<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Earn Now - User</title>

  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Ad scripts (alternating between Adexora and Adextra) -->
  <script src="https://adexora.com/cdn/ads.js?id=141" defer></script>
  <script async src="https://partner.adextra.io/jt/02550eb738a9bc745b2d1ca9865a18866fad3996.js"></script>

  <!-- Firebase (compat - works with older code patterns) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary-gradient: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);
      --card-bg: rgba(255,255,255,0.95);
      --glass-bg: rgba(255,255,255,0.12);
      --text-dark: #222;
      --accent: #6a11cb;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Roboto,Arial;}
    body{background:var(--primary-gradient);min-height:100vh;padding:20px;color:var(--text-dark);display:flex;justify-content:center;}
    .app{width:100%;max-width:520px;background:var(--glass-bg);border-radius:16px;padding-bottom:30px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.18);border:1px solid rgba(255,255,255,0.08);}
    header{background:linear-gradient(135deg,#2575fc 0%,#6a11cb 100%);color:#fff;padding:26px;text-align:center;}
    header h1{font-size:22px;margin-bottom:6px;}
    .balance-card{background:var(--card-bg);margin:18px auto;padding:18px;border-radius:12px;width:88%;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
    .balance-amount{font-size:34px;color:var(--accent);font-weight:800;}
    .content{padding:18px;}
    .section{background:var(--card-bg);padding:18px;border-radius:12px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:all 0.3s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    .btn-primary{background:linear-gradient(90deg,#6a11cb,#2575fc);color:#fff;}
    .btn-secondary{background:#fff;border:1px solid #e6e6e6;color:#333;}
    .btn-success{background:linear-gradient(90deg,#28a745,#20c997);color:#fff;}
    .btn-warning{background:linear-gradient(90deg,#ffc107,#fd7e14);color:#fff;}
    .task-info{display:flex;justify-content:space-between;margin-top:10px;color:#666;font-size:13px;flex-wrap:wrap;}
    .task-info > div {margin-right:10px;}
    .task-progress{height:8px;background:#eee;border-radius:6px;margin-top:10px;overflow:hidden;}
    .task-bar{height:100%;background:linear-gradient(90deg,#6a11cb,#2575fc);width:0%}
    .withdrawal-form{margin-top:12px}
    .method-cards{display:flex;gap:8px;flex-wrap:wrap}
    .method-card{padding:10px;border-radius:10px;border:1px solid #e9e9e9;min-width:90px;text-align:center;cursor:pointer;background:#fff;transition:all 0.2s ease;}
    .method-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1);}
    .method-card.selected{border-color:var(--accent);background:rgba(106,17,203,0.06)}
    .amount-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .amount-btn{padding:10px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer;font-weight:700;transition:all 0.2s ease;}
    .amount-btn:hover{transform:translateY(-2px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .amount-btn.selected{border-color:var(--accent);background:rgba(106,17,203,0.06)}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid #e9e9e9;margin-top:8px}
    .history-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#fff;margin-bottom:8px;border:1px solid #f3f3f3}
    .status-badge{padding:6px 10px;border-radius:18px;font-weight:700;font-size:12px}
    .status-pending{background:#fff3cd;color:#856404}
    .status-paid{background:#d4edda;color:#155724}
    .status-rejected{background:#f8d7da;color:#721c24}
    .notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;color:#fff;display:none;z-index:3000}
    .firebase-loading{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:4000}
    .ad-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:3500}
    .ad-box{background:#fff;padding:20px;border-radius:12px;width:92%;max-width:360px;text-align:center}
    .small{font-size:13px;color:#666}
    
    /* New styles for community and referral sections */
    .community-section {display:flex;flex-direction:column;gap:12px;margin-top:12px;}
    .community-btn {width:100%;justify-content:center;text-align:center;}
    .referral-section {margin-top:16px;}
    .referral-code {background:#f8f9fa;padding:14px;border-radius:10px;margin-top:10px;text-align:center;border:1px dashed #ddd;}
    .referral-code-text {font-size:18px;font-weight:800;letter-spacing:1px;color:var(--accent);margin:8px 0;}
    .referral-stats {display:flex;justify-content:space-around;margin-top:14px;text-align:center;}
    .stat-box {flex:1;padding:10px;}
    .stat-value {font-size:20px;font-weight:800;color:var(--accent);}
    .stat-label {font-size:12px;color:#666;}
    .referral-instructions {margin-top:14px;padding:12px;background:#f0f8ff;border-radius:8px;border-left:4px solid var(--accent);}
    .referral-instructions ol {padding-left:20px;margin-top:8px;}
    .referral-instructions li {margin-bottom:6px;}
    
    /* Animation for spin */
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    
    /* Ad container styling */
    .ad-container {margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 8px; text-align: center;}
    #adextra-container {display: none;}
  </style>
</head>
<body>
  <div class="firebase-loading" id="firebaseLoading">
    <div style="text-align:center;color:white">
      <div style="width:48px;height:48px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px"></div>
      <div>Loading...</div>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <div class="app" role="application">
    <header>
      <h1>Earn Now</h1>
      <div class="balance-card">
        <div class="small">Your Balance</div>
        <div class="balance-amount">‡ß≥ <span id="balance">0.00</span></div>
        <div class="small" id="current-date"></div>
      </div>
    </header>

    <div class="content">
      <div class="section">
        <h3>Watch Ads & Earn</h3>
        <div style="margin-top:12px">
          <button id="watchAdBtn" class="btn btn-primary">üëÅÔ∏è Watch Ad & Earn ‡ß≥<span id="perAd">0.06</span></button>
        </div>
        <div class="task-info">
          <div>Watched: <strong id="todayCount">0</strong>/<strong id="dailyLimit">10</strong></div>
          <div>Clicks: <strong id="todayClicks">0</strong></div>
          <div id="resetTime" class="small">Resets in 24h</div>
        </div>
        <div class="task-progress" aria-hidden="true"><div id="taskBar" class="task-bar"></div></div>
      </div>

      <!-- New Community Section -->
      <div class="section">
        <h3>Join Our Community</h3>
        <div class="community-section">
          <button id="joinChannelBtn" class="btn btn-success community-btn">üì¢ Join Our Channel</button>
          <button id="joinGroupBtn" class="btn btn-warning community-btn">üí¨ Join Support Group</button>
        </div>
      </div>

      <!-- New Referral Section -->
      <div class="section">
        <h3>Refer & Earn</h3>
        <div class="referral-section">
          <div class="small">Invite friends and earn ‡ß≥1 for each successful referral!</div>
          
          <div class="referral-code">
            <div class="small">Your Referral Code:</div>
            <div class="referral-code-text" id="referralCode">LOADING...</div>
            <button id="copyRefCode" class="btn btn-primary" style="margin-top:8px">üìã Copy Code</button>
          </div>
          
          <div class="referral-stats">
            <div class="stat-box">
              <div class="stat-value" id="refCount">0</div>
              <div class="stat-label">Referrals</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">‡ß≥<span id="refEarnings">0</span></div>
              <div class="stat-label">Earned</div>
            </div>
          </div>
          
          <div class="referral-instructions">
            <div class="small" style="font-weight:700">How to refer:</div>
            <ol class="small">
              <li>Share your referral code with friends</li>
              <li>Ask them to use your code during registration</li>
              <li>Earn ‡ß≥1 when they complete their first ad watch</li>
            </ol>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Withdraw Money</h3>
        <div style="margin-top:10px">
          <button id="toggleWithdraw" class="btn btn-secondary">üí∏ Request Withdrawal</button>
        </div>

        <div id="withdrawForm" class="withdrawal-form" style="display:none">
          <div style="margin-top:10px">
            <div class="small">Select Method</div>
            <div id="methodCards" class="method-cards" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:12px">
            <div class="small">Account / Mobile Number</div>
            <input id="accountNumber" class="input" placeholder="Enter number (e.g. 01XXXXXXXXX)">
          </div>

          <div style="margin-top:12px">
            <div class="small">Select Amount</div>
            <div class="amount-grid" id="amountGrid">
              <button class="amount-btn" data-amount="20">‡ß≥20</button>
              <button class="amount-btn" data-amount="50">‡ß≥50</button>
              <button class="amount-btn" data-amount="100">‡ß≥100</button>
              <button class="amount-btn" data-amount="200">‡ß≥200</button>
              <button class="amount-btn" data-amount="300">‡ß≥300</button>
              <button class="amount-btn" data-amount="500">‡ß≥500</button>
            </div>
            <input id="withdrawAmount" type="number" class="input" placeholder="Or enter custom amount (20 - 500)" min="20" max="500" style="margin-top:8px">
          </div>

          <div style="margin-top:14px">
            <button id="submitWithdraw" class="btn btn-primary">‚úÖ Submit Request</button>
          </div>
        </div>

        <h4 style="margin-top:18px">Withdrawal History</h4>
        <div id="historyList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- Ad Modal -->
  <div class="ad-modal" id="adModal">
    <div class="ad-box">
      <h3>Advertisement</h3>
      <div id="adexora-container" class="ad-container">
        <div id="adStatus" class="small">Loading Adexora ad...</div>
      </div>
      <div id="adextra-container" class="ad-container">
        <div id="02550eb738a9bc745b2d1ca9865a18866fad3996"></div>
        <div id="adextraStatus" class="small">Loading Adextra ad...</div>
      </div>
      <div style="margin-top:16px"><button id="adDoneBtn" class="btn btn-primary" style="display:none">OK</button></div>
    </div>
  </div>

<script>
/* ========== Helpers ========== */
function showNotification(msg, success=true, ms=2200){
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.style.background = success ? 'linear-gradient(90deg,#28a745,#1e7e34)' : 'linear-gradient(90deg,#dc3545,#bd2130)';
  el.style.display = 'block';
  setTimeout(()=> el.style.display = 'none', ms);
}

/* ========== Firebase init ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDp49URVg2ipSBuoEBGZyqWWyc29cxAleE",
  authDomain: "easy-earn-af82c.firebaseapp.com",
  projectId: "easy-earn-af82c",
  storageBucket: "easy-earn-af82c.firebasestorage.app",
  messagingSenderId: "572340074151",
  appId: "1:572340074151:web:778d58946c1163427acd82",
  measurementId: "G-3RFZSPZD9W"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

/* ========== App state ========== */
let tg; // Telegram WebApp object
let uid = null;
let userData = { 
  balance: 0, 
  adHistory: [], 
  adClickHistory: [], 
  activityLog: [], 
  todayAdCount: 0, 
  todayAdClicks: 0, 
  lastAdReset: new Date().toDateString(),
  totalEarned: 0,
  totalWithdrawn: 0,
  referralCode: '',
  referredBy: '',
  referrals: [],
  referralEarnings: 0
};
let withdrawalMethods = [];
let allRequests = [];
let perAdRate = 0.06;
let dailyLimit = 10;
let userIP = "Unknown";
let userCountry = "Unknown";
let adClickRate = 0.05; // Rate when user clicks the ad
let adNoClickRate = 0.04; // Rate when user doesn't click the ad
let currentAdNetwork = 'adexora'; // Track which ad network to show next

/* ========== DOM refs ========== */
const balanceEl = () => document.getElementById('balance');
const perAdEl = () => document.getElementById('perAd');
const todayCountEl = () => document.getElementById('todayCount');
const todayClicksEl = () => document.getElementById('todayClicks');
const dailyLimitEl = () => document.getElementById('dailyLimit');
const taskBarEl = () => document.getElementById('taskBar');
const resetTimeEl = () => document.getElementById('resetTime');
const watchAdBtn = () => document.getElementById('watchAdBtn');
const toggleWithdrawBtn = () => document.getElementById('toggleWithdraw');
const withdrawFormEl = () => document.getElementById('withdrawForm');
const methodCardsEl = () => document.getElementById('methodCards');
const amountGridEl = () => document.getElementById('amountGrid');
const withdrawAmountInput = () => document.getElementById('withdrawAmount');
const accountNumberInput = () => document.getElementById('accountNumber');
const submitWithdrawBtn = () => document.getElementById('submitWithdraw');
const historyListEl = () => document.getElementById('historyList');
const firebaseLoading = () => document.getElementById('firebaseLoading');
const adModal = () => document.getElementById('adModal');
const adStatus = () => document.getElementById('adStatus');
const adDoneBtn = () => document.getElementById('adDoneBtn');
const adexoraContainer = () => document.getElementById('adexora-container');
const adextraContainer = () => document.getElementById('adextra-container');

// New DOM refs for community and referral
const joinChannelBtn = () => document.getElementById('joinChannelBtn');
const joinGroupBtn = () => document.getElementById('joinGroupBtn');
const referralCodeEl = () => document.getElementById('referralCode');
const copyRefCodeBtn = () => document.getElementById('copyRefCode');
const refCountEl = () => document.getElementById('refCount');
const refEarningsEl = () => document.getElementById('refEarnings');

/* ========== Utility functions ========== */
function formatDateField(d){
  if(!d) return '';
  if (d && typeof d.toDate === 'function') {
    return d.toDate().toLocaleString();
  } else if (typeof d === 'string') {
    try { return new Date(d).toLocaleString(); } catch(e){ return d; }
  } else if (d instanceof Date) return d.toLocaleString();
  return String(d);
}

function updateResetTimeUI(){
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate()+1);
  tomorrow.setHours(0,0,0,0);
  const diff = tomorrow - now;
  const hrs = Math.floor(diff/(1000*60*60));
  const mins = Math.floor((diff%(1000*60*60))/(1000*60));
  resetTimeEl().textContent = `Resets in ${hrs}h ${mins}m`;
}

// Ad click simulation
function simulateAdClick() {
  return new Promise((resolve) => {
    const clicked = Math.random() < 0.7;
    setTimeout(() => resolve(clicked), 1000);
  });
}

// Generate referral code
function generateReferralCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let result = '';
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

/* ========== Daily Reset Logic ========== */
function checkAndResetDailyCounts() {
  const today = new Date().toDateString();
  if (userData.lastAdReset !== today) {
    console.log('Resetting daily counts for new day');
    
    // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡¶Ø‡¶º
    userData.lastAdReset = today;
    userData.todayAdCount = 0;
    userData.todayAdClicks = 0;
    
    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
    saveUserToServer().catch(e => console.error('Reset save error:', e));
    return true;
  }
  return false;
}

/* ========== Load user IP & country ========== */
async function detectLocation(){
  try {
    const r = await fetch('https://api.ipify.org?format=json');
    const j = await r.json();
    userIP = j.ip || 'Unknown';
    const r2 = await fetch(`https://ipapi.co/${userIP}/json/`);
    const j2 = await r2.json();
    userCountry = j2.country_code || 'Unknown';
  } catch(e){
    console.warn('Location detect failed', e);
    userIP = 'Unknown'; userCountry = 'Unknown';
  }
}

/* ========== Load & Save from Firestore ========== */
async function loadUserFromServer(){
  try {
    const doc = await db.collection('users').doc(uid).get();
    if (doc.exists){
      const data = doc.data();
      
      // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶æ‡¶®‡ßá‡¶®‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
      userData.balance = parseFloat(data.balance || 0);
      userData.totalEarned = parseFloat(data.totalEarned || 0);
      userData.totalWithdrawn = parseFloat(data.totalWithdrawn || 0);
      userData.adHistory = data.adHistory || [];
      userData.adClickHistory = data.adClickHistory || [];
      userData.activityLog = data.activityLog || [];
      userData.registrationDate = data.registrationDate || new Date().toISOString();
      userData.userId = data.userId || uid;
      
      // Referral data
      userData.referralCode = data.referralCode || generateReferralCode();
      userData.referredBy = data.referredBy || '';
      userData.referrals = data.referrals || [];
      userData.referralEarnings = parseFloat(data.referralEarnings || 0);
      
      // ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
      userData.todayAdCount = parseInt(data.todayAdCount || 0);
      userData.todayAdClicks = parseInt(data.todayAdClicks || 0);
      userData.lastAdReset = data.lastAdReset || new Date().toDateString();
      
      // ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
      checkAndResetDailyCounts();
      
      console.log('User data loaded - Balance:', userData.balance, 'Today Count:', userData.todayAdCount);
    } else {
      // ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
      const today = new Date().toDateString();
      userData = {
        balance: 0,
        totalEarned: 0,
        totalWithdrawn: 0,
        adHistory: [],
        adClickHistory: [],
        activityLog: [],
        todayAdCount: 0,
        todayAdClicks: 0,
        lastAdReset: today,
        registrationDate: new Date().toISOString(),
        userId: uid,
        referralCode: generateReferralCode(),
        referredBy: '',
        referrals: [],
        referralEarnings: 0
      };
      await db.collection('users').doc(uid).set(userData);
      console.log('New user created');
    }
  } catch (e){
    console.error('loadUserFromServer error', e);
    showNotification('Error loading user data', false);
    userData.balance = 0;
  }
}

async function loadWithdrawalRequests(){
  try {
    const snap = await db.collection('withdrawalRequests')
      .where('userId', '==', uid)
      .orderBy('date', 'desc')
      .get();
    
    allRequests = snap.docs.map(d => ({ 
      id: d.id, 
      ...d.data(),
      date: d.data().date || new Date().toISOString()
    }));
  } catch(e){
    console.error('loadWithdrawalRequests error', e);
    // Fallback: try without ordering
    try {
      const snap = await db.collection('withdrawalRequests')
        .where('userId', '==', uid)
        .get();
      allRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch(err) {
      console.error('Fallback load error:', err);
      allRequests = [];
    }
  }
}

async function loadSettings(){
  try {
    const s = await db.collection('settings').doc('appSettings').get();
    if (s.exists){
      const v = s.data();
      perAdRate = parseFloat(v.perAdRate || perAdRate);
      dailyLimit = parseInt(v.dailyTaskLimit || dailyLimit);
      adClickRate = parseFloat(v.adClickRate || adClickRate);
      adNoClickRate = parseFloat(v.adNoClickRate || adNoClickRate);
    }
    const methodsDoc = await db.collection('settings').doc('withdrawalMethods').get();
    if (methodsDoc.exists){
      const vm = methodsDoc.data();
      withdrawalMethods = vm.methods || [];
    } else {
      withdrawalMethods = [
        { name: 'bKash', enabled: true },
        { name: 'Nagad', enabled: true },
        { name: 'Rocket', enabled: true },
        { name: 'Banglalink', enabled: true },
        { name: 'Grameenphone', enabled: true },
        { name: 'Robi', enabled: true },
        { name: 'Airtel', enabled: true }
      ];
    }
  } catch(e){
    console.warn('loadSettings error', e);
  }
}

async function saveUserToServer(){
  try {
    await db.collection('users').doc(uid).set({
      ...userData,
      lastUpdate: new Date().toISOString()
    }, { merge: true });
    console.log('User data saved - Balance:', userData.balance, 'Today Count:', userData.todayAdCount);
  } catch(e){
    console.error('saveUserToServer error', e);
    showNotification('Error saving data', false);
  }
}

/* ========== UI render functions ========== */
function renderUI(){
  // ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
  checkAndResetDailyCounts();
  
  const balance = parseFloat(userData.balance || 0);
  balanceEl().textContent = balance.toFixed(2);
  
  perAdEl().textContent = perAdRate.toFixed(2);
  todayCountEl().textContent = userData.todayAdCount || 0;
  todayClicksEl().textContent = userData.todayAdClicks || 0;
  dailyLimitEl().textContent = dailyLimit;
  
  const pct = ((userData.todayAdCount || 0) / dailyLimit) * 100;
  taskBarEl().style.width = `${Math.min(pct,100)}%`;
  updateResetTimeUI();
  renderMethods();
  renderHistory();
  renderReferralUI();
}

function renderMethods(){
  const container = methodCardsEl();
  container.innerHTML = '';
  const enabled = (withdrawalMethods || []).filter(m=>m.enabled);
  if (enabled.length === 0){
    container.innerHTML = '<div class="small">No methods available</div>';
    return;
  }
  enabled.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'method-card';
    div.dataset.method = m.name.toLowerCase();
    
    const logos = {
      'bkash': 'üè¶',
      'nagad': 'üì±', 
      'rocket': 'üöÄ',
      'banglalink': 'üì∂',
      'grameenphone': 'üìû',
      'robi': 'üî¥',
      'airtel': 'üÖ∞Ô∏è'
    };
    
    const logo = logos[m.name.toLowerCase()] || 'üí≥';
    
    div.innerHTML = `
      <div style="font-size:24px;margin-bottom:5px">${logo}</div>
      <div style="font-weight:800">${m.name}</div>
      <div class="small">Tap to select</div>
    `;
    div.addEventListener('click', ()=> {
      document.querySelectorAll('.method-card').forEach(c=>c.classList.remove('selected'));
      div.classList.add('selected');
    });
    container.appendChild(div);
  });
}

function renderHistory(){
  const container = historyListEl();
  container.innerHTML = '';
  const myReqs = (allRequests || []).filter(r => String(r.userId) === String(uid) || String(r.userId) === String(userData.userId));
  if (myReqs.length === 0){
    container.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:#666">No withdrawal history</div>';
    return;
  }
  myReqs.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'history-item';
    const left = document.createElement('div');
    
    let formattedDate = 'Unknown';
    if (r.date) {
      const dateObj = typeof r.date.toDate === 'function' ? r.date.toDate() : new Date(r.date);
      if (!isNaN(dateObj.getTime())) {
        const day = dateObj.getDate();
        const month = dateObj.getMonth() + 1;
        const year = dateObj.getFullYear();
        formattedDate = `${day}-${month}-${year}`;
      }
    }
    
    left.innerHTML = `<div style="font-weight:800">${(r.method||'--').toString()}</div><div class="small">${formattedDate}</div>`;
    const right = document.createElement('div');
    const statusClass = r.status === 'paid' ? 'status-paid' : (r.status === 'rejected' ? 'status-rejected' : 'status-pending');
    right.innerHTML = `<div style="text-align:right">‡ß≥${(r.amount||0)}<div style="margin-top:6px"><span class="status-badge ${statusClass}">${r.status || 'pending'}</span></div></div>`;
    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });
}

function renderReferralUI() {
  referralCodeEl().textContent = userData.referralCode || 'N/A';
  refCountEl().textContent = userData.referrals ? userData.referrals.length : 0;
  refEarningsEl().textContent = userData.referralEarnings ? userData.referralEarnings.toFixed(2) : '0.00';
}

/* ========== Community and Referral Functions ========== */
function openCommunityChannel() {
  window.open('https://t.me/easyearn1211', '_blank');
}

function openSupportGroup() {
  window.open('https://t.me/+kx6C43GeG4ljY2Jl', '_blank');
}

function copyReferralCode() {
  const code = userData.referralCode;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(() => {
      showNotification('Referral code copied to clipboard!');
    }).catch(err => {
      fallbackCopyText(code);
    });
  } else {
    fallbackCopyText(code);
  }
}

function fallbackCopyText(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand('copy');
    showNotification('Referral code copied to clipboard!');
  } catch (err) {
    console.error('Fallback: Unable to copy', err);
    showNotification('Failed to copy code. Please copy manually.', false);
  }
  document.body.removeChild(textArea);
}

/* ========== Withdraw flow ========== */
async function submitWithdrawRequest(){
  const selected = document.querySelector('.method-card.selected');
  if (!selected) return showNotification('Please select a withdrawal method', false);
  const method = selected.dataset.method;
  const number = accountNumberInput().value.trim();
  let amount = parseFloat(withdrawAmountInput().value);
  
  // Validation improvements
  if (!number) return showNotification('Please enter account number', false);
  if (number.length < 11) return showNotification('Please enter valid account number (11 digits)', false);
  if (isNaN(amount) || amount <= 0) return showNotification('Please enter valid amount', false);
  if (amount < 20 || amount > 500) return showNotification('Amount must be between 20 and 500', false);
  if (userData.balance < amount) return showNotification('Insufficient balance', false);

  const userRef = db.collection('users').doc(uid);
  const reqsRef = db.collection('withdrawalRequests');

  try {
    // Show loading
    submitWithdrawBtn().disabled = true;
    submitWithdrawBtn().textContent = 'Submitting...';

    // Use transaction for data consistency
    await db.runTransaction(async (tx) => {
      const userSnap = await tx.get(userRef);
      if (!userSnap.exists) throw new Error('User not found');
      
      const serverUser = userSnap.data();
      const serverBalance = parseFloat(serverUser.balance || 0);
      
      if (serverBalance < amount) throw new Error('INSUFFICIENT_BALANCE');

      // Update user balance
      tx.update(userRef, {
        balance: serverBalance - amount,
        totalWithdrawn: parseFloat(serverUser.totalWithdrawn || 0) + amount,
        lastUpdate: new Date().toISOString()
      });

      // Create withdrawal request
      const newReqRef = reqsRef.doc();
      tx.set(newReqRef, {
        userId: uid,
        method: method,
        number: number,
        amount: amount,
        status: 'pending',
        date: new Date().toISOString(), // Use client timestamp
        ip: userIP,
        country: userCountry,
        userName: userData.name || 'Unknown',
        userUsername: userData.username || 'Unknown'
      });
    });

    // Update local state
    userData.balance -= amount;
    userData.totalWithdrawn += amount;
    
    // Reload requests
    await loadWithdrawalRequests();
    
    // Reset form
    withdrawFormEl().style.display = 'none';
    accountNumberInput().value = '';
    withdrawAmountInput().value = '';
    document.querySelectorAll('.amount-btn').forEach(b=>b.classList.remove('selected'));
    document.querySelectorAll('.method-card').forEach(c=>c.classList.remove('selected'));
    
    // Update UI
    renderUI();
    showNotification('Withdrawal request submitted successfully!');
    
  } catch (error) {
    console.error('Withdrawal error:', error);
    if (error.message === 'INSUFFICIENT_BALANCE') {
      showNotification('Insufficient balance. Please refresh and try again.', false);
    } else {
      showNotification('Error submitting request. Please try again.', false);
    }
  } finally {
    submitWithdrawBtn().disabled = false;
    submitWithdrawBtn().textContent = '‚úÖ Submit Request';
  }
}

/* ========== Ad watching flow ========== */
async function watchAd(){
  // Check daily limit
  if (userData.todayAdCount >= dailyLimit) {
    return showNotification(`Daily limit reached (${dailyLimit} ads)`, false);
  }
  
  // Show loading
  watchAdBtn().disabled = true;
  watchAdBtn().textContent = 'Loading Ad...';
  
  try {
    // Show ad modal
    adModal().style.display = 'flex';
    
    // Reset ad containers
    adexoraContainer().style.display = 'none';
    adextraContainer().style.display = 'none';
    adDoneBtn().style.display = 'none';
    
    // Determine which ad network to show
    if (currentAdNetwork === 'adexora') {
      adexoraContainer().style.display = 'block';
      adStatus().textContent = 'Loading Adexora ad...';
      currentAdNetwork = 'adextra'; // Next time show Adextra
    } else {
      adextraContainer().style.display = 'block';
      adStatus().textContent = 'Loading Adextra ad...';
      currentAdNetwork = 'adexora'; // Next time show Adexora
    }
    
    // Simulate ad loading (replace with actual ad loading)
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Show ad completion button
    adDoneBtn().style.display = 'block';
    adStatus().textContent = 'Ad loaded. Watch the ad and click OK when done.';
    
    // Wait for user to complete the ad
    await new Promise(resolve => {
      adDoneBtn().onclick = () => resolve();
    });
    
    // Simulate ad click detection
    const clicked = await simulateAdClick();
    
    // Calculate earnings based on click
    const earnings = clicked ? adClickRate : adNoClickRate;
    
    // Update user data
    userData.todayAdCount += 1;
    if (clicked) userData.todayAdClicks += 1;
    userData.balance += earnings;
    userData.totalEarned += earnings;
    
    // Add to history
    userData.adHistory.push({
      date: new Date().toISOString(),
      earnings: earnings,
      clicked: clicked,
      network: currentAdNetwork === 'adexora' ? 'Adexora' : 'Adextra'
    });
    
    // Save to server
    await saveUserToServer();
    
    // Update UI
    renderUI();
    
    // Show success message
    showNotification(`You earned ‡ß≥${earnings.toFixed(2)} from watching an ad! ${clicked ? '(Clicked)' : ''}`);
    
  } catch (error) {
    console.error('Ad watching error:', error);
    showNotification('Error loading ad. Please try again.', false);
  } finally {
    // Reset UI
    adModal().style.display = 'none';
    watchAdBtn().disabled = false;
    watchAdBtn().textContent = `üëÅÔ∏è Watch Ad & Earn ‡ß≥${perAdRate.toFixed(2)}`;
  }
}

/* ========== Event listeners ========== */
function setupEventListeners(){
  // Watch ad button
  watchAdBtn().addEventListener('click', watchAd);
  
  // Withdrawal toggle
  toggleWithdrawBtn().addEventListener('click', ()=>{
    const isVisible = withdrawFormEl().style.display === 'block';
    withdrawFormEl().style.display = isVisible ? 'none' : 'block';
    toggleWithdrawBtn().textContent = isVisible ? 'üí∏ Request Withdrawal' : '‚ùå Cancel';
  });
  
  // Amount buttons
  amountGridEl().querySelectorAll('.amount-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.amount-btn').forEach(btn=>btn.classList.remove('selected'));
      b.classList.add('selected');
      withdrawAmountInput().value = b.dataset.amount;
    });
  });
  
  // Custom amount input
  withdrawAmountInput().addEventListener('input', (e)=>{
    const v = parseFloat(e.target.value);
    document.querySelectorAll('.amount-btn').forEach(btn=>{
      btn.classList.toggle('selected', parseFloat(btn.dataset.amount) === v);
    });
  });
  
  // Submit withdrawal
  submitWithdrawBtn().addEventListener('click', submitWithdrawRequest);
  
  // Ad done button
  adDoneBtn().addEventListener('click', () => {
    // This is handled in the watchAd function
  });
  
  // Community buttons
  joinChannelBtn().addEventListener('click', openCommunityChannel);
  joinGroupBtn().addEventListener('click', openSupportGroup);
  
  // Referral copy button
  copyRefCodeBtn().addEventListener('click', copyReferralCode);
}

/* ========== Initialize app ========== */
async function initApp(){
  try {
    firebaseLoading().style.display = 'flex';
    
    // Detect location
    await detectLocation();
    
    // Initialize Telegram WebApp
    tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();
    
    // Get user info from Telegram
    const user = tg.initDataUnsafe?.user;
    uid = user?.id?.toString() || `tg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
    
    // Set user data from Telegram
    if (user) {
      userData.name = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'Telegram User';
      userData.username = user.username || 'No username';
      userData.userId = user.id.toString();
    } else {
      userData.name = 'Telegram User';
      userData.username = 'No username';
    }
    
    // Load settings and user data
    await Promise.all([loadSettings(), loadUserFromServer(), loadWithdrawalRequests()]);
    
    // Setup UI
    setupEventListeners();
    renderUI();
    
    // Update current date
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Show welcome message
    setTimeout(() => {
      showNotification(`Welcome ${userData.name}! Start earning by watching ads.`);
    }, 1000);
    
  } catch (error) {
    console.error('App initialization error:', error);
    showNotification('Error initializing app', false);
  } finally {
    firebaseLoading().style.display = 'none';
  }
}

// Start the app
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
